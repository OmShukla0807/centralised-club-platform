{% extends "base.html" %}

{% block title %}Dashboard - Campus Connect{% endblock %}

{% block content %}
<h2>All Clubs</h2>
<div id="clubs-container">
    <p>Loading clubs...</p>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function loadClubs() {
        const token = localStorage.getItem("access_token");
        
        // 1. Check if logged in
        if (!token) {
            window.location.href = "/login-page";
            return;
        }

        // 2. Fetch Data from API
        try {
            const response = await fetch("/clubs", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}` // Send the Wristband!
                }
            });

            if (response.ok) {
                const clubs = await response.json();
                renderClubs(clubs);
            } else {
                console.error("Failed to fetch clubs");
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }

    // 3. Render HTML
    function renderClubs(clubs) {
        const container = document.getElementById("clubs-container");
        container.innerHTML = ""; // Clear "Loading..." text

        if (clubs.length === 0) {
            container.innerHTML = "<p>No clubs found. Be the first to start one!</p>";
            return;
        }

        // Loop through each club and make a card
        clubs.forEach(club => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
    <h3>${club.name}</h3>
    <p>${club.description}</p>
    <button class="btn" onclick="joinClub(${club.id})">Join</button>
    
    <a href="/manage/${club.id}" class="btn" style="background-color: #4b5563; text-decoration:none; font-size:1rem;">
        Manage (Admin)
    </a>
`;
            container.appendChild(card);
        });
    }

    // 4. Join Function
    async function joinClub(clubId) {
        const token = localStorage.getItem("access_token");
        const response = await fetch(`/clubs/${clubId}/join`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            alert("Joined successfully!");
        } else {
            const err = await response.json();
            alert("Error: " + err.detail);
        }
    }
    
    // placeholder function
    function viewEvents(clubId) {
        alert("Event view coming soon!");
    }

    // Run on page load
    loadClubs();
</script>
{% endblock %}